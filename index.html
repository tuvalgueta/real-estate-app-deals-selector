<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מנתח עסקאות נדל"ן</title>
    <!-- 1. Include Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Include SheetJS (xlsx.full.min.js) for reading/writing Excel files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        /* Use Inter font */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">מנתח דמיון עסקאות נדל"ן</h2>
        
        <p class="text-center text-gray-600 mb-6">
            העלה קובץ אקסל (במבנה הנדרש) כדי לקבל ניתוח של 7 העסקאות הדומות ביותר לנכס ההשוואה.
        </p>

        <!-- File Input -->
        <div class="mb-4">
            <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-2">בחר קובץ אקסל:</label>
            <input id="file-upload" type="file"
                   accept=".xlsx, .xls"
                   class="block w-full text-sm text-gray-500
                          file:mr-4 file:ml-4 file:py-2 file:px-4
                          file:rounded-lg file:border-0 file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100 cursor-pointer border rounded-lg p-2.5">
        </div>

        <!-- Process Button -->
        <button id="process-button" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
            נתח וסנן עסקאות
        </button>

        <!-- Loader (hidden by default) -->
        <div id="loader" class="flex justify-center items-center mt-6 hidden">
            <div class="spinner"></div>
            <span class="mr-4 text-gray-700">מעבד נתונים...</span>
        </div>

        <!-- Message Area -->
        <div id="message" class="mt-4 text-center text-sm font-medium"></div>

    </div>

    <script>
        // Get DOM elements
        const fileInput = document.getElementById('file-upload');
        const processButton = document.getElementById('process-button');
        const messageEl = document.getElementById('message');
        const loader = document.getElementById('loader');

        // --- Configuration: Sheet and Key Names ---
        // These MUST match the names in your Excel file
        const COMPARISON_SHEET_NAME = 'נכס השוואה';
        const DEALS_SHEET_NAME = 'עסקאות נדל"ן';
        
        // Key names in the "Comparison" sheet
        const COMP_KEYS = {
            area: 'שטח אקוויוולנטי',
            year: 'שנת בניה',
            floor: 'קומה',
            parking: 'חניה',
            address: 'כתובת' // New: Added address
        };
        
        // Column names in the "Deals" sheet
        const DEAL_COLS = {
            area: 'שטח ברוטו', // Comparing Equivalent Area to Gross Area
            year: 'שנת בניה',
            floor: 'קומה',
            parking: 'חניות',
            address: 'כתובת',      // New: Added address
            date: 'יום מכירה'      // New: Added date
        };
        
        const NEW_COLUMN_NAME = 'ציון דמיון';
        // ------------------------------------------

        /**
         * Safely parses floor values, converting 'ק' (Ground) to 0.
         */
        function parseFloor(floorValue) {
            if (typeof floorValue === 'number') {
                return floorValue;
            }
            if (!floorValue) {
                return 0; // Treat empty/null/undefined as 0
            }
            
            // Trim whitespace and check for 'ק'
            const strFloor = String(floorValue).trim();
            
            if (strFloor === 'ק') {
                return 0; // "ק" (קרקע) is ground floor (0)
            }
            
            // Try to parse as a number
            const num = parseInt(strFloor, 10);
            
            // If parsing fails (e.g., "מרתף"), return 0. Otherwise, return the number.
            // --- FIX: Added missing return statement and closing brace ---
            return isNaN(num) ? 0 : num;
        }

        /**
         * Safely parses date strings (e.g., "dd/mm/yyyy") or Date objects.
         */
        function parseDate(dateInput) {
            // New: Check if it's already a valid Date object
            if (dateInput instanceof Date && !isNaN(dateInput)) {
                return dateInput;
            }
            
            // If not, try to parse it as a string
            if (typeof dateInput !== 'string') return null;
            
            // Check for "dd/mm/yyyy" format
            // --- FIX: Changed dateStr to dateInput ---
            const parts = dateInput.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
                const year = parseInt(parts[2], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }
            
            // Fallback for other formats (like ISO yyyy-mm-dd)
            const parsed = new Date(dateInput);
            return isNaN(parsed) ? null : parsed;
        }

        // Attach event listener to the button
        processButton.addEventListener('click', handleFileProcess);

        /**
         * Main function to handle file processing
         */
        async function handleFileProcess() {
            const file = fileInput.files[0];

            // Reset UI
            messageEl.textContent = '';
            messageEl.className = 'mt-4 text-center text-sm font-medium';
            loader.classList.remove('hidden');
            processButton.classList.add('hidden');

            if (!file) {
                showError("אנא בחר קובץ.");
                resetUI();
                return;
            }

            try {
                // 1. Read the workbook
                messageEl.textContent = 'קורא קובץ...';
                const workbook = await readWorkbook(file);

                // 2. Extract the comparison property data
                messageEl.textContent = 'מחלץ נכס להשוואה...';
                const comparisonProp = extractComparisonProperty(workbook);

                // 3. Extract the deals data
                messageEl.textContent = 'מחלץ עסקאות...';
                const deals = extractDeals(workbook);

                // 4. Calculate similarity scores
                messageEl.textContent = 'מחשב ציוני דמיון...';
                const scoredDeals = calculateScores(comparisonProp, deals);

                // 5. Generate and download the new workbook
                messageEl.textContent = 'יוצר קובץ חדש...';
                generateNewWorkbook(scoredDeals, workbook.Sheets[COMPARISON_SHEET_NAME]);
                
                showSuccess('הקובץ נוצר והורד בהצלחה!');

            } catch (error) {
                console.error(error);
                showError(error.message);
            } finally {
                // Reset UI
                resetUI();
            }
        }

        /**
         * Reads the uploaded file into a SheetJS workbook object
         */
        function readWorkbook(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // --- IMPORTANT: Set cellDates: true to force date parsing ---
                        // This will read date-formatted numbers as JS Date objects.
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        resolve(workbook);
                    } catch (err) {
                        reject(new Error('שגיאה בקריאת הקובץ. ודא שזהו קובץ אקסל תקין.'));
                    }
                };
                reader.onerror = (err) => reject(new Error('שגיאה בטעינת הקובץ.'));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * Extracts the key data points from the comparison property sheet
         */
        function extractComparisonProperty(workbook) {
            const sheet = workbook.Sheets[COMPARISON_SHEET_NAME];
            if (!sheet) {
                throw new Error(`הגיליון "${COMPARISON_SHEET_NAME}" לא נמצא בקובץ.`);
            }
            
            // Read as array of arrays to find key-value pairs
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const prop = {};

            data.forEach(row => {
                const key = row[0]; // Key is in the first column
                const value = row[1]; // Value is in the second column

                if (key === COMP_KEYS.area) prop.area = parseFloat(value);
                if (key === COMP_KEYS.year) prop.year = parseInt(value, 10);
                if (key === COMP_KEYS.floor) prop.floor = parseFloor(value);
                if (key === COMP_KEYS.parking) prop.parking = parseInt(value, 10);
                if (key === COMP_KEYS.address) prop.address = String(value || '').trim(); // New
            });

            // Validate that we found all keys
            const missingKeys = Object.keys(COMP_KEYS).filter(key => prop[COMP_KEYS[key]] === undefined);
            if (!prop.area || !prop.year || prop.floor === undefined || prop.parking === undefined || !prop.address) {
                console.warn('Data found:', prop);
                throw new Error(`לא כל הנתונים נמצאו בגליון "${COMPARISON_SHEET_NAME}". ודא שהשמות: ${Object.values(COMP_KEYS).join(', ')} קיימים בעמודה A והערכים בעמודה B.`);
            }
            
            // Convert parking to a boolean (has parking or not) for simpler comparison
            prop.hasParking = prop.parking > 0;
            
            return prop;
        }

        /**
         * Extracts the list of deals from the deals sheet
         */
        function extractDeals(workbook) {
            const sheet = workbook.Sheets[DEALS_SHEET_NAME];
            if (!sheet) {
                throw new Error(`הגיליון "${DEALS_SHEET_NAME}" לא נמצא בקובץ.`);
            }

            // The header is on the 3rd row (index 2). 'range: 2' tells SheetJS to start there.
            // We now use default options to let the JS Date objects (from cellDates:true) pass through.
            const deals = XLSX.utils.sheet_to_json(sheet, { range: 2 });
            
            if (deals.length === 0) {
                throw new Error('לא נמצאו עסקאות בגיליון.');
            }
            
            // Check if required columns exist in the first deal
            const firstDeal = deals[0];
            // New: Added address and date to required list
            const requiredCols = [DEAL_COLS.area, DEAL_COLS.year, DEAL_COLS.floor, DEAL_COLS.parking, DEAL_COLS.address, DEAL_COLS.date];
            for (const col of requiredCols) {
                if (!(col in firstDeal)) {
                    throw new Error(`העמודה "${col}" חסרה בגליון "${DEALS_SHEET_NAME}".`);
                }
            }

            return deals;
        }

        /**
         * Calculates a similarity score for each deal against the comparison property
         * A *lower* score means a *better* match.
         */
        function calculateScores(prop, deals) {
            // New: Added today's date for date scoring
            const today = new Date();
            
            // New: Updated weights. Date is highest. Sum must be 1.
            const weights = {
                date: 0.40,
                area: 0.25,
                year: 0.15,
                floor: 0.10,
                parking: 0.10
            };
            
            const propAddress = (prop.address || "").trim(); // Get comparison address once

            return deals.map(deal => {
                // --- Get deal values ---
                const dealArea = parseFloat(deal[DEAL_COLS.area] || 0);
                const dealYear = parseInt(deal[DEAL_COLS.year] || 0, 10);
                const dealFloor = parseFloor(deal[DEAL_COLS.floor]);
                const dealParking = parseInt(deal[DEAL_COLS.parking] || 0, 10);
                const dealHasParking = dealParking > 0;
                const dealAddress = (deal[DEAL_COLS.address] || "").trim(); // New
                const dealDate = parseDate(deal[DEAL_COLS.date]); // New
                
                // --- Calculate individual scores (0-100 scale, 0 is perfect match) ---
                
                // New: Date Score
                // 0 points for today, 100 points for 10 years ago (3650 days)
                let dateScore = 100; // Max penalty by default
                if (dealDate) {
                    const diffTime = Math.abs(today - dealDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    // (diffDays / 36.5) gives ~100 points for 10 years
                    dateScore = Math.min(100, diffDays / 36.5);
                }

                // Area Score: (e.g., 50% difference = 100 points)
                const areaScore = prop.area > 0 ? Math.min(100, (Math.abs(dealArea - prop.area) / prop.area) * 200) : (dealArea > 0 ? 100 : 0);
                
                // Year Score: (e.g., 20 years difference = 100 points)
                const yearScore = Math.min(100, Math.abs(dealYear - prop.year) * 5);
                
                // Floor Score: (e.g., 4 floors difference = 100 points)
                const floorScore = Math.min(100, Math.abs(dealFloor - prop.floor) * 25);
                
                // Parking Score: 100 if mismatch, 0 if match
                const parkingScore = (dealHasParking !== prop.hasParking) ? 100 : 0;

                // --- Calculate final weighted score ---
                const totalScore = (dateScore * weights.date) +
                                   (areaScore * weights.area) +
                                   (yearScore * weights.year) +
                                   (floorScore * weights.floor) +
                                   (parkingScore * weights.parking);

                // --- New: Apply Address Bonus ---
                let bonusPoints = 0;
                if (dealAddress && propAddress && dealAddress === propAddress) {
                    bonusPoints = 25; // A 25-point bonus for exact address match
                }
                
                const finalScore = totalScore - bonusPoints;

                // Add the new score to the deal object
                // Ensure score is not negative after bonus
                deal[NEW_COLUMN_NAME] = parseFloat(Math.max(0, finalScore).toFixed(2));
                
                return deal;
            });
        }

        /**
         * Generates a new workbook with the top 7 deals and all scored deals
         */
        function generateNewWorkbook(scoredDeals, comparisonSheet) {
            // Sort deals by score, ascending (lowest score is best)
            scoredDeals.sort((a, b) => a[NEW_COLUMN_NAME] - b[NEW_COLUMN_NAME]);

            // Get the top 7 deals
            const top7Deals = scoredDeals.slice(0, 7);
            
            // --- NEW: Format dates back to dd/mm/yyyy strings for Excel ---
            // Helper function to format Date objects
            /*
            const formatDate = (dateInput) => {
                if (dateInput instanceof Date && !isNaN(dateInput)) {
                    const day = String(dateInput.getDate()).padStart(2, '0');
                    const month = String(dateInput.getMonth() + 1).padStart(2, '0'); // +1 because months are 0-indexed
                    const year = dateInput.getFullYear();
                    return `${day}/${month}/${year}`;
                }
                // If it's not a date (e.g., it was a number we failed to parse or just text), return it as-is
                return dateInput; 
            };
            */
            // Apply REAL date formatting to the 'יום מכירה' column
            const formatDate = (dateInput) => {
            return dateInput instanceof Date && !isNaN(dateInput) ? dateInput : null;
            };
            
            // Apply formatting to both lists by creating new arrays
            const formattedTop7 = top7Deals.map(deal => ({
                ...deal,
                [DEAL_COLS.date]: formatDate(deal[DEAL_COLS.date])
            }));
            const formattedAllScored = scoredDeals.map(deal => ({
                ...deal,
                [DEAL_COLS.date]: formatDate(deal[DEAL_COLS.date])
            }));

            // Create new worksheets from the *formatted* data
            // We use cellDates: false to ensure our new strings are treated as strings
            //old can remove if works
            //const ws_top7 = XLSX.utils.json_to_sheet(formattedTop7, { cellDates: false });
            //const ws_all_scored = XLSX.utils.json_to_sheet(formattedAllScored, { cellDates: false });
            
            const ws_top7 = XLSX.utils.json_to_sheet(formattedTop7, { cellDates: true });
            const ws_all_scored = XLSX.utils.json_to_sheet(formattedAllScored, { cellDates: true });            
            
            // Set new sheets to RTL
            //ws_top7['!props'] = { rtl: true };
            //ws_all_scored['!props'] = { rtl: true };
            // Force RTL sheet direction (same as Excel's "Sheet Right-to-Left")
            ws_top7['!views'] = [{ rightToLeft: true }];
            ws_all_scored['!views'] = [{ rightToLeft: true }];
            // Create a new workbook
            const newWorkbook = XLSX.utils.book_new();

            // Append the new sheets
            XLSX.utils.book_append_sheet(newWorkbook, ws_top7, "Top 7 Deals");
            XLSX.utils.book_append_sheet(newWorkbook, ws_all_scored, "All Scored Deals");
            
            // Append the original comparison sheet for reference
            XLSX.utils.book_append_sheet(newWorkbook, comparisonSheet, COMPARISON_SHEET_NAME);

            // Trigger the download
            XLSX.writeFile(newWorkbook, "Scored_Real_Estate_Deals.xlsx");
        }
        
        // --- UI Helper Functions ---

        function showError(message) {
            messageEl.textContent = message;
            messageEl.className = 'mt-4 text-center text-sm font-medium text-red-600';
        }
        
        function showSuccess(message) {
            messageEl.textContent = message;
            messageEl.className = 'mt-4 text-center text-sm font-medium text-green-600';
        }

        function resetUI() {
            loader.classList.add('hidden');
            processButton.classList.remove('hidden');
            fileInput.value = ''; // Clear the file input
        }

    </script>
</body>
</html>

